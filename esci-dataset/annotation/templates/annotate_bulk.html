<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ ESCI Bulk Annotation Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        .progress-container {
            margin: 15px 0;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin: 8px 0;
            font-size: 13px;
        }

        /* Skip to Record */
        .skip-container {
            text-align: center;
            margin: 15px 0;
        }
        .skip-container input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        .skip-container button {
            padding: 4px 12px;
            margin-left: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Multi-Record Grid - 1 Column */
        #recordsGrid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .record-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: all 0.2s;
        }


        .record-card.focused {
            border-color: #007bff;
            border-width: 3px;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            background-color: #f8f9ff;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-number {
            font-weight: bold;
            color: #6c757d;
            font-size: 12px;
        }

        .current-label-mini {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Side by side layout within card */
        .content-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 12px;
        }

        .consumable-section {
            padding: 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
            border-left: 3px solid #1f77b4;
        }

        .query-section {
            padding: 10px;
            border-radius: 6px;
            background-color: #fff8f5;
            border-left: 3px solid #ff6b35;
        }

        .consumable-id {
            color: #6c757d;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .consumable-name {
            font-weight: bold;
            color: #1f77b4;
            font-size: 20px;
            line-height: 1.3;
        }

        .query-text {
            font-weight: bold;
            color: #ff6b35;
            font-style: italic;
            font-size: 18px;
            line-height: 1.3;
        }

        .section-label {
            font-size: 10px;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .esci-buttons-mini {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .btn-esci-mini {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 24px;
        }

        .btn-esci-mini:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-E { background-color: #28a745; color: white; }
        .btn-S { background-color: #ffc107; color: black; }
        .btn-C { background-color: #17a2b8; color: white; }
        .btn-I { background-color: #dc3545; color: white; }

        /* Label color classes */
        .label-E { background-color: #d4edda; color: #155724; }
        .label-S { background-color: #fff3cd; color: #856404; }
        .label-C { background-color: #d1ecf1; color: #0c5460; }
        .label-I { background-color: #f8d7da; color: #721c24; }

        /* Compact Navigation */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .btn-nav {
            padding: 6px 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-nav:hover { background-color: #5a6268; }
        .btn-nav:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Compact Shortcuts */
        .shortcuts {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
            font-size: 11px;
        }

        /* Status Messages */
        .status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
            font-size: 12px;
        }
        .status.success { background-color: #28a745; }
        .status.error { background-color: #dc3545; }

        /* Edit/Delete button styles */
        .btn-edit { background-color: #ffc107; color: black; }
        .btn-delete { background-color: #dc3545; color: white; }

        .edit-buttons {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            justify-content: center;
        }

        .btn-edit-mini, .btn-delete-mini {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            min-width: 30px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .modal input[type="text"], .modal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        .modal-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .modal-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <div class="status" id="status"></div>

    <div class="container">
        <div class="header">
            <h1>üöÄ ESCI Bulk Annotation Tool</h1>
            <div id="fileInfo">Loading...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Progress -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressText">0 / 0</span>
                </div>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: center; gap: 20px; align-items: center; margin: 15px 0;">
                <div class="skip-container">
                    <label for="skipToRecord">Go to:</label>
                    <input type="number" id="skipToRecord" min="1" max="1">
                    <button onclick="skipToRecord()">Go</button>
                </div>
                <div>
                    <label for="pageSize">Per page:</label>
                    <select id="pageSize" onchange="changePageSize()" style="padding: 4px; margin-left: 5px;">
                        <option value="4"{% if page_size == 4 %} selected{% endif %}>4</option>
                        <option value="6"{% if page_size == 6 %} selected{% endif %}>6</option>
                        <option value="8"{% if page_size == 8 %} selected{% endif %}>8</option>
                        <option value="10"{% if page_size == 10 %} selected{% endif %}>10</option>
                        <option value="12"{% if page_size == 12 %} selected{% endif %}>12</option>
                        <option value="16"{% if page_size == 16 %} selected{% endif %}>16</option>
                        <option value="20"{% if page_size == 20 %} selected{% endif %}>20</option>
                    </select>
                </div>
            </div>

            <!-- Multiple Records Grid -->
            <div id="recordsGrid"></div>

            <!-- Navigation -->
            <div class="nav-buttons">
                <button class="btn-nav" id="prevBtn" onclick="navigatePage(-1)">‚óÄ Prev Page</button>
                <button class="btn-nav" id="nextBtn" onclick="navigatePage(1)">Next Page ‚ñ∂</button>
                <button class="btn-nav" onclick="window.location.reload()">Reload</button>
            </div>

            <!-- Keyboard Shortcuts -->
            <div class="shortcuts">
                <strong>‚å®Ô∏è Shortcuts:</strong> Click card to focus ‚Ä¢ ‚Üê‚Üí‚Üë‚Üì=Navigate focus ‚Ä¢ Z=E X=S C=C V=I ‚Ä¢ Shift+‚Üê‚Üí=Pages ‚Ä¢ Esc=Clear label ‚Ä¢ Enter=Copy AI
            </div>
        </div>
    </div>

    <!-- Edit Query Modal -->
    <div id="editQueryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editQueryModal')">&times;</span>
            <h3>‚úèÔ∏è Edit Query</h3>
            <p>Record <strong id="editRecordNumber"></strong>:</p>
            <textarea id="editQueryInput" rows="3" placeholder="Enter new query..."></textarea>
            <div class="modal-buttons">
                <button class="btn-nav" onclick="saveQueryEdit()" style="background-color: #007bff;">üíæ Save</button>
                <button class="btn-nav" onclick="closeModal('editQueryModal')">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Example Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('confirmDeleteModal')">&times;</span>
            <h3>‚ö†Ô∏è Delete Example</h3>
            <p>Are you sure you want to delete record <strong id="deleteRecordNumber"></strong>?</p>
            <p>This will:</p>
            <ul>
                <li>Remove the example completely</li>
                <li>Delete all associated labels</li>
                <li><strong>This cannot be undone!</strong></li>
            </ul>
            <div class="modal-buttons">
                <button class="btn-nav" onclick="confirmDeleteExample()" style="background-color: #dc3545;">üóëÔ∏è Delete</button>
                <button class="btn-nav" onclick="closeModal('confirmDeleteModal')">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Label Modal -->
    <div id="confirmDeleteLabelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('confirmDeleteLabelModal')">&times;</span>
            <h3>‚ö†Ô∏è Clear Label</h3>
            <p>Clear your label for record <strong id="clearLabelRecordNumber"></strong>?</p>
            <p>This will remove your annotation but keep the example.</p>
            <div class="modal-buttons">
                <button class="btn-nav" onclick="confirmDeleteLabel()" style="background-color: #dc3545;">üóëÔ∏è Clear</button>
                <button class="btn-nav" onclick="closeModal('confirmDeleteLabelModal')">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let currentPage = 0;
        let recordsPerPage = {{ page_size }};
        let filename = '';
        let focusedCardIndex = -1; // Track which card is focused (-1 = none)

        // Load data from Flask API
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const result = await response.json();

                if (result.error) {
                    document.getElementById('fileInfo').textContent = 'Error: ' + result.error;
                    return;
                }

                data = result.data;
                filename = result.filename;

                document.getElementById('fileInfo').textContent = `üìÅ ${filename} (${result.total} records)`;
                document.getElementById('mainContent').style.display = 'block';

                if (data.length > 0) {
                    document.getElementById('skipToRecord').max = data.length;
                    displayPage(0);
                }
            } catch (error) {
                document.getElementById('fileInfo').textContent = 'Error loading data: ' + error.message;
            }
        }

        // Display current page of records
        function displayPage(pageNum) {
            const totalPages = Math.ceil(data.length / recordsPerPage);
            if (pageNum < 0 || pageNum >= totalPages) return;

            currentPage = pageNum;
            // Clear focus when changing pages
            focusedCardIndex = -1;
            const startIdx = pageNum * recordsPerPage;
            const endIdx = Math.min(startIdx + recordsPerPage, data.length);

            // Update progress
            const progress = (endIdx / data.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${endIdx} / ${data.length} (Page ${pageNum + 1} of ${totalPages})`;

            // Clear and populate records grid
            const grid = document.getElementById('recordsGrid');
            grid.innerHTML = '';


            for (let i = startIdx; i < endIdx; i++) {
                const item = data[i];
                const recordCard = createRecordCard(item, i);
                grid.appendChild(recordCard);
            }

            // Navigation buttons are always enabled (circular navigation)
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;

            // Update skip input to show first record of page
            document.getElementById('skipToRecord').value = startIdx + 1;

            // Auto-focus the first card if no card is currently focused
            if (focusedCardIndex === -1 && startIdx < data.length) {
                setTimeout(() => focusCard(startIdx), 100);
            }
        }

        // Detect if we're in database mode (has separate human/AI labels) or CSV mode
        function isDatabaseMode(item) {
            return item.hasOwnProperty('human_esci_label') || item.hasOwnProperty('ai_esci_label');
        }


        // Create a record card
        function createRecordCard(item, index) {
            const card = document.createElement('div');
            card.className = 'record-card';
            card.setAttribute('data-index', index);

            // Add click handler for focus
            card.addEventListener('click', () => focusCard(index));

            const labelNames = { E: 'Exact', S: 'Substitute', C: 'Complement', I: 'Irrelevant', '': 'Not Labeled' };
            const labelEmojis = { E: 'üü¢', S: 'üü°', C: 'üü†', I: 'üî¥', '': '‚ö´' };

            let labelHtml = '';
            if (isDatabaseMode(item)) {
                // Database mode: show both human and AI labels
                const humanLabel = item.human_esci_label || '';
                const aiLabel = item.ai_esci_label || '';
                labelHtml = `
                    <div style="font-size: 9px; line-height: 1.2;">
                        <div class="current-label-mini ${humanLabel ? `label-${humanLabel}` : ''}" style="margin-bottom: 2px; padding: 1px 4px;">
                            üë§ ${humanLabel ? `${labelEmojis[humanLabel]} ${humanLabel}` : '‚ö´ None'}
                        </div>
                        <div class="current-label-mini ${aiLabel ? `label-${aiLabel}` : ''}" style="padding: 1px 4px;">
                            ü§ñ ${aiLabel ? `${labelEmojis[aiLabel]} ${aiLabel}` : '‚ö´ None'}
                        </div>
                    </div>`;
            } else {
                // CSV mode: show single combined label
                const currentLabel = item.esci_label || 'I';
                labelHtml = `<span class="current-label-mini label-${currentLabel}">${labelEmojis[currentLabel]} ${currentLabel}</span>`;
            }

            card.innerHTML = `
                <div class="record-header">
                    <span class="record-number">#${index + 1}</span>
                    ${labelHtml}
                </div>
                <div class="content-row">
                    <div class="consumable-section">
                        <div class="section-label">üçΩÔ∏è CONSUMABLE</div>
                        <div class="consumable-id">ID: ${item.consumable_id || ''}</div>
                        <div class="consumable-name">üì¶ ${item.consumable_name || ''}</div>
                    </div>
                    <div class="query-section">
                        <div class="section-label">üîç QUERY</div>
                        <div class="query-text">üîé "${item.query || ''}"</div>
                    </div>
                </div>
                <div class="esci-buttons-mini">
                    <button class="btn-esci-mini btn-E" onclick="setLabel(${index}, 'E')">E</button>
                    <button class="btn-esci-mini btn-S" onclick="setLabel(${index}, 'S')">S</button>
                    <button class="btn-esci-mini btn-C" onclick="setLabel(${index}, 'C')">C</button>
                    <button class="btn-esci-mini btn-I" onclick="setLabel(${index}, 'I')">I</button>
                </div>
                <div class="edit-buttons">
                    <button class="btn-edit-mini btn-edit" onclick="editQuery(${index})">‚úèÔ∏è Edit</button>
                    <button class="btn-delete-mini btn-delete" onclick="deleteLabel(${index})">üóëÔ∏è Clear</button>
                    <button class="btn-delete-mini btn-delete" onclick="deleteExample(${index})">‚ùå Del</button>
                </div>
            `;

            return card;
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 1500);
        }

        // Set ESCI label for specific record
        async function setLabel(index, label) {
            if (data.length === 0) return;

            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: index,
                        label: label
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data based on mode
                    const item = data[index];
                    if (isDatabaseMode(item)) {
                        // Database mode: update human label
                        data[index].human_esci_label = label;
                        showStatus(`‚úÖ #${index + 1} ‚Üí ${label} (human)`, 'success');
                    } else {
                        // CSV mode: update combined label
                        data[index].esci_label = label;
                        showStatus(`‚úÖ #${index + 1} ‚Üí ${label}`, 'success');
                    }

                    // Refresh the entire page to update label display
                    const previousFocus = focusedCardIndex;
                    displayPage(currentPage);
                    // Restore focus after page refresh
                    if (previousFocus !== -1) {
                        setTimeout(() => focusCard(previousFocus), 50);
                    }
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error', 'error');
            }
        }

        // Navigate pages (circular)
        function navigatePage(direction) {
            const totalPages = Math.ceil(data.length / recordsPerPage);
            if (totalPages <= 1) return; // No navigation needed with only one page

            let newPage = currentPage + direction;

            // Wrap around: if going before first page, go to last page
            if (newPage < 0) {
                newPage = totalPages - 1;
            }
            // Wrap around: if going after last page, go to first page
            else if (newPage >= totalPages) {
                newPage = 0;
            }

            displayPage(newPage);
        }

        // Change page size
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSize').value);
            const currentRecord = (currentPage * recordsPerPage) + 1; // First record of current page

            recordsPerPage = newPageSize;

            // Calculate new page for the same record
            const newPage = Math.floor((currentRecord - 1) / recordsPerPage);
            displayPage(newPage);

            showStatus(`üìè Changed to ${newPageSize} records per page`, 'success');
        }

        // Skip to specific record
        function skipToRecord() {
            const input = document.getElementById('skipToRecord');
            const recordNumber = parseInt(input.value);

            if (isNaN(recordNumber) || recordNumber < 1 || recordNumber > data.length) {
                showStatus(`‚ùå Invalid: 1-${data.length}`, 'error');
                const startIdx = currentPage * recordsPerPage;
                input.value = startIdx + 1;
                return;
            }

            // Calculate which page contains this record
            const targetPage = Math.floor((recordNumber - 1) / recordsPerPage);
            displayPage(targetPage);
            showStatus(`üìç Record ${recordNumber} (Page ${targetPage + 1})`, 'success');
        }

        // Focus management functions
        function focusCard(index) {
            // Remove focus from all cards
            const cards = document.querySelectorAll('.record-card');
            cards.forEach(card => card.classList.remove('focused'));

            // Focus the clicked card
            focusedCardIndex = index;
            const targetCard = document.querySelector(`[data-index="${index}"]`);
            if (targetCard) {
                targetCard.classList.add('focused');
                // Scroll the focused card into view
                targetCard.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                    inline: 'nearest'
                });
            }
        }

        function clearFocus() {
            const cards = document.querySelectorAll('.record-card');
            cards.forEach(card => card.classList.remove('focused'));
            focusedCardIndex = -1;
        }

        function moveFocus(direction) {
            if (data.length === 0) return;

            if (focusedCardIndex === -1) {
                // No card focused, focus first visible on current page
                const startIdx = currentPage * recordsPerPage;
                focusCard(startIdx);
                return;
            }

            const totalPages = Math.ceil(data.length / recordsPerPage);
            // Fixed 1-column grid
            const cols = 1;

            let newFocusIndex = focusedCardIndex;
            let needPageChange = false;
            let newPage = currentPage;

            if (direction === 'right') {
                newFocusIndex = focusedCardIndex + 1;
                // Check if we've moved beyond the last record
                if (newFocusIndex >= data.length) {
                    newFocusIndex = 0; // Wrap to first record
                    newPage = 0;
                    needPageChange = true;
                }
            } else if (direction === 'left') {
                newFocusIndex = focusedCardIndex - 1;
                // Check if we've moved before the first record
                if (newFocusIndex < 0) {
                    newFocusIndex = data.length - 1; // Wrap to last record
                    newPage = totalPages - 1;
                    needPageChange = true;
                }
            } else if (direction === 'down') {
                // Move down by 2 (next row in 2-column grid)
                newFocusIndex = focusedCardIndex + cols;
                if (newFocusIndex >= data.length) {
                    // Wrap to first record in same column
                    const currentCol = focusedCardIndex % cols;
                    newFocusIndex = currentCol;
                    newPage = 0;
                    needPageChange = true;
                }
            } else if (direction === 'up') {
                // Move up by 2 (previous row in 2-column grid)
                newFocusIndex = focusedCardIndex - cols;
                if (newFocusIndex < 0) {
                    // Wrap to last record in same column
                    const currentCol = focusedCardIndex % cols;
                    const lastRecordSameCol = Math.floor((data.length - 1 - currentCol) / cols) * cols + currentCol;
                    newFocusIndex = lastRecordSameCol >= 0 ? lastRecordSameCol : data.length - 1;
                    newPage = Math.floor(newFocusIndex / recordsPerPage);
                    needPageChange = true;
                }
            }

            // Check if we need to change pages for records not at boundaries
            if (!needPageChange) {
                const targetPage = Math.floor(newFocusIndex / recordsPerPage);
                if (targetPage !== currentPage) {
                    newPage = targetPage;
                    needPageChange = true;
                }
            }

            if (needPageChange && newPage !== currentPage) {
                // Change page and then focus
                currentPage = newPage;
                displayPage(newPage);
                // Wait a moment for page to render, then focus
                setTimeout(() => focusCard(newFocusIndex), 100);
            } else {
                // Same page, just focus
                focusCard(newFocusIndex);
            }
        }

        function labelFocusedCard(label) {
            if (focusedCardIndex !== -1) {
                setLabel(focusedCardIndex, label);
            }
        }

        async function deleteLabelFocusedCard() {
            if (focusedCardIndex === -1) return;

            try {
                const response = await fetch('/api/delete-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: focusedCardIndex
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data - clear the appropriate label
                    const item = data[focusedCardIndex];
                    if (isDatabaseMode(item)) {
                        // Database mode: clear human label
                        data[focusedCardIndex].human_esci_label = '';
                    } else {
                        // CSV mode: clear combined label
                        data[focusedCardIndex].esci_label = '';
                    }
                    // Refresh to show updated label and restore focus
                    const previousFocus = focusedCardIndex;
                    displayPage(currentPage);
                    setTimeout(() => focusCard(previousFocus), 50);
                    showStatus(`‚úÖ Cleared label for #${previousFocus + 1}`);
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }
        }

        async function copyAiLabelFocusedCard() {
            if (focusedCardIndex === -1) return;

            const item = data[focusedCardIndex];
            if (!isDatabaseMode(item)) {
                showStatus('‚ùå Copy AI label only works in database mode', 'error');
                return;
            }

            try {
                const response = await fetch('/api/copy-ai-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: focusedCardIndex
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    data[focusedCardIndex].human_esci_label = data[focusedCardIndex].ai_esci_label;
                    // Refresh to show updated label and restore focus
                    const previousFocus = focusedCardIndex;
                    displayPage(currentPage);
                    setTimeout(() => focusCard(previousFocus), 50);
                    showStatus(`‚úÖ ${result.message}`);
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Enter' && e.target.id === 'skipToRecord') {
                    e.preventDefault();
                    skipToRecord();
                }
                return;
            }
            if (data.length === 0) return;

            switch(e.key.toLowerCase()) {
                // Navigation keys
                case 'arrowleft':
                    e.preventDefault();
                    if (e.shiftKey) {
                        // Shift + Left = Previous page
                        navigatePage(-1);
                    } else {
                        // Left = Move focus left
                        moveFocus('left');
                    }
                    break;
                case 'arrowright':
                    e.preventDefault();
                    if (e.shiftKey) {
                        // Shift + Right = Next page
                        navigatePage(1);
                    } else {
                        // Right = Move focus right
                        moveFocus('right');
                    }
                    break;
                case 'arrowup':
                    e.preventDefault();
                    moveFocus('up');
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    moveFocus('down');
                    break;

                // Labeling shortcuts
                case 'z':
                    e.preventDefault();
                    labelFocusedCard('E');
                    break;
                case 'x':
                    e.preventDefault();
                    labelFocusedCard('S');
                    break;
                case 'c':
                    e.preventDefault();
                    labelFocusedCard('C');
                    break;
                case 'v':
                    e.preventDefault();
                    labelFocusedCard('I');
                    break;

                // Delete human label from focused card
                case 'escape':
                    e.preventDefault();
                    deleteLabelFocusedCard();
                    break;

                // Copy AI label to human label
                case 'enter':
                    e.preventDefault();
                    copyAiLabelFocusedCard();
                    break;
            }
        });

        // Load data when page loads
        window.addEventListener('load', loadData);

        // Global variables for edit operations
        let editingIndex = -1;

        // Edit query functionality
        function editQuery(index) {
            editingIndex = index;
            const item = data[index];
            document.getElementById('editRecordNumber').textContent = `#${index + 1}`;
            document.getElementById('editQueryInput').value = item.query || '';
            document.getElementById('editQueryModal').style.display = 'block';
        }

        async function saveQueryEdit() {
            const newQuery = document.getElementById('editQueryInput').value.trim();
            if (!newQuery) {
                showStatus('‚ùå Query cannot be empty', 'error');
                return;
            }

            try {
                const response = await fetch('/api/update-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: editingIndex,
                        query: newQuery
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    data[editingIndex].query = newQuery;
                    closeModal('editQueryModal');
                    displayPage(currentPage); // Refresh the page to show updated query
                    showStatus(`‚úÖ #${editingIndex + 1} query updated!`);
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Delete example functionality
        function deleteExample(index) {
            editingIndex = index;
            document.getElementById('deleteRecordNumber').textContent = `#${index + 1}`;
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        async function confirmDeleteExample() {
            try {
                const response = await fetch('/api/delete-example', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: editingIndex
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Remove from local data array
                    data.splice(editingIndex, 1);
                    closeModal('confirmDeleteModal');

                    if (data.length === 0) {
                        showStatus('üìä All examples deleted!');
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('fileInfo').textContent = 'No data remaining';
                    } else {
                        // Adjust current page if needed
                        const totalPages = Math.ceil(data.length / recordsPerPage);
                        if (currentPage >= totalPages) {
                            currentPage = totalPages - 1;
                        }
                        displayPage(currentPage);
                        showStatus(`‚úÖ ${result.message}`);
                        // Update skip input max value
                        document.getElementById('skipToRecord').max = data.length;
                    }
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Delete label functionality
        function deleteLabel(index) {
            editingIndex = index;
            document.getElementById('clearLabelRecordNumber').textContent = `#${index + 1}`;
            document.getElementById('confirmDeleteLabelModal').style.display = 'block';
        }

        async function confirmDeleteLabel() {
            try {
                const response = await fetch('/api/delete-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        index: editingIndex
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data - clear the appropriate label
                    const item = data[editingIndex];
                    if (isDatabaseMode(item)) {
                        // Database mode: clear human label
                        data[editingIndex].human_esci_label = '';
                    } else {
                        // CSV mode: clear combined label
                        data[editingIndex].esci_label = '';
                    }
                    closeModal('confirmDeleteLabelModal');
                    displayPage(currentPage); // Refresh to show updated label
                    showStatus(`‚úÖ ${result.message}`);
                } else {
                    showStatus('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Modal management
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingIndex = -1;
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modals = ['editQueryModal', 'confirmDeleteModal', 'confirmDeleteLabelModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    editingIndex = -1;
                }
            });
        });

        console.log('üöÄ ESCI Bulk Annotation Tool loaded');
        console.log('Multi-record view: Adjustable records per page');
        console.log('Click E/S/C/I buttons on each card to annotate');
        console.log('Use dropdown to change page size: 4-20 records');
        console.log('‚úèÔ∏è New features: Edit queries, delete examples, clear labels');
    </script>
</body>
</html>